<!-- ============================================================
     SYSTEM LOG v2.0 — state persists across SPA navigations
     Uses window.__tacticalState so the console only re-opens
     when explicitly triggered, never on navigation.
     ============================================================ -->

<!-- CTRL+K Toast (5s, once per session) -->
<div id="ctrlk-toast" class="fixed top-4 right-4 z-[300] flex items-center gap-3 px-4 py-3 bg-zinc-900/95 border border-[var(--primary)]/40 rounded-xl backdrop-blur-md shadow-xl font-mono text-xs text-white/80 opacity-0 pointer-events-none transition-all duration-500" aria-live="polite" style="transform: translateY(-8px);">
    <span class="text-[var(--primary)] font-mono font-bold">[$]</span>
    <span>Pressione <kbd class="px-1.5 py-0.5 bg-white/10 rounded text-[var(--primary)] font-bold text-[10px]">Ctrl</kbd> + <kbd class="px-1.5 py-0.5 bg-white/10 rounded text-[var(--primary)] font-bold text-[10px]">K</kbd> para abrir o terminal</span>
    <div id="ctrlk-progress" class="absolute bottom-0 left-0 h-[2px] bg-[var(--primary)]/50 w-full rounded-b-xl origin-left transition-transform duration-[5000ms] linear"></div>
</div>

<!-- System Log Panel — hidden by default -->
<div
    id="tactical-console"
    class="fixed bottom-0 left-0 right-0 sm:bottom-4 sm:left-4 sm:right-auto z-[100] sm:w-72 md:w-80 bg-black/90 backdrop-blur-md border-t sm:border sm:rounded-lg border-[var(--primary)]/30 font-mono text-[10px] shadow-2xl overflow-hidden"
    style="display:none;"
>
    <div class="bg-[var(--primary)]/10 px-3 py-1.5 flex justify-between items-center border-b border-[var(--primary)]/20">
        <span class="text-[var(--primary)] font-black tracking-tighter uppercase flex items-center gap-2">
            <span class="w-1.5 h-1.5 bg-[var(--primary)] rounded-full animate-pulse"></span>
            System Log v2.0
        </span>
        <div class="flex gap-1">
            <button id="console-minimize" title="Minimizar" class="text-white/30 hover:text-[var(--primary)] px-1.5 py-0.5 rounded hover:bg-white/5 transition-colors text-[10px]">▼</button>
            <button id="console-close" title="Fechar" class="text-white/30 hover:text-red-400 px-1.5 py-0.5 rounded hover:bg-white/5 transition-colors text-[10px]">✕</button>
        </div>
    </div>
    <div id="console-logs" class="p-3 h-24 sm:h-32 overflow-y-auto space-y-1 bg-[var(--primary)]/5 transition-all duration-300">
        <div class="text-[var(--primary)]/40">[BOOT] System ready.</div>
    </div>
</div>

<script>
(function() {
    // Persistent state — survives SPA navigations
    if (!window.__tacticalState) {
        window.__tacticalState = {
            visible: false,      // whether panel is currently shown
            closed: false,       // user explicitly closed it (don't auto-reopen)
            minimized: false,
            logs: [],            // scrollback buffer
            toastShown: false,
        };
    }

    const STATE = window.__tacticalState;

    function getEls() {
        return {
            panel:    document.getElementById('tactical-console'),
            logsEl:   document.getElementById('console-logs'),
            minBtn:   document.getElementById('console-minimize'),
            closeBtn: document.getElementById('console-close'),
            toast:    document.getElementById('ctrlk-toast'),
            progress: document.getElementById('ctrlk-progress'),
        };
    }

    function showPanel() {
        const { panel } = getEls();
        if (!panel) return;
        panel.style.display = 'block';
        STATE.visible = true;
        STATE.closed = false;
    }

    function hidePanel() {
        const { panel } = getEls();
        if (!panel) return;
        panel.style.display = 'none';
        STATE.visible = false;
        STATE.closed = true;
    }

    function setMinimized(minimized) {
        const { logsEl, minBtn } = getEls();
        if (!logsEl) return;
        STATE.minimized = minimized;
        if (minimized) {
            logsEl.style.height = '0';
            logsEl.style.padding = '0';
            logsEl.style.overflow = 'hidden';
            if (minBtn) minBtn.textContent = '▲';
        } else {
            logsEl.style.height = '';
            logsEl.style.padding = '';
            logsEl.style.overflow = '';
            if (minBtn) minBtn.textContent = '▼';
        }
    }

    function addLog(message, type = 'info') {
        const { logsEl } = getEls();
        const time = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
        const colorMap = { success: 'text-green-400', error: 'text-red-400', warning: 'text-yellow-400', info: 'text-white/60' };
        
        // Add to buffer
        STATE.logs.push({ time, message, type });
        if (STATE.logs.length > 50) STATE.logs.shift(); // cap buffer

        if (!logsEl) return;
        
        const log = document.createElement('div');
        log.className = `${colorMap[type] || 'text-white/60'} leading-tight transition-all duration-300 opacity-0 -translate-x-2`;
        log.innerHTML = `<span class="opacity-30">[${time}]</span> ${message}`;
        logsEl.appendChild(log);
        requestAnimationFrame(() => log.classList.remove('opacity-0', '-translate-x-2'));
        logsEl.scrollTop = logsEl.scrollHeight;

        // Only auto-show if user hasn't explicitly closed it
        if (!STATE.closed) {
            showPanel();
            if (STATE.minimized) setMinimized(false); // un-minimize on new log
        }
    }

    function renderScrollback() {
        const { logsEl } = getEls();
        if (!logsEl) return;
        const colorMap = { success: 'text-green-400', error: 'text-red-400', warning: 'text-yellow-400', info: 'text-white/60' };
        // Clear and re-render buffer
        logsEl.innerHTML = '';
        STATE.logs.forEach(({ time, message, type }) => {
            const log = document.createElement('div');
            log.className = `${colorMap[type] || 'text-white/60'} leading-tight`;
            log.innerHTML = `<span class="opacity-30">[${time}]</span> ${message}`;
            logsEl.appendChild(log);
        });
        logsEl.scrollTop = logsEl.scrollHeight;
    }

    function showToast() {
        if (STATE.toastShown) return;
        STATE.toastShown = true;

        const { toast, progress } = getEls();
        if (!toast || !progress) return;

        setTimeout(() => {
            toast.style.opacity = '1';
            toast.style.transform = 'translateY(0)';
            toast.classList.remove('pointer-events-none');
            // Delay to allow CSS to register initial state before animating
            setTimeout(() => { progress.style.transform = 'scaleX(0)'; }, 50);
            // Hide after 5.5s
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-8px)';
                toast.classList.add('pointer-events-none');
            }, 5500);
        }, 1800);
    }

    function setup() {
        const { panel, logsEl, minBtn, closeBtn } = getEls();
        if (!panel) return;

        // Restore from persistent state
        renderScrollback();
        if (STATE.visible && !STATE.closed) {
            showPanel();
            setMinimized(STATE.minimized);
        }

        // Button listeners (re-attach on SPA navigation)
        minBtn?.addEventListener('click', (e) => {
            e.stopPropagation();
            setMinimized(!STATE.minimized);
        });
        closeBtn?.addEventListener('click', (e) => {
            e.stopPropagation();
            hidePanel();
        });

        // Listen for events from other components
        window.addEventListener('tactical-log', (e) => addLog(e.detail.message, e.detail.type));

        // Log meaningful interactions (not console buttons)
        document.addEventListener('click', (e) => {
            const el = e.target?.closest('a[href], button:not(#console-minimize):not(#console-close):not(#console-toggle)');
            if (el) {
                const label = (el.innerText || el.getAttribute('aria-label') || '').trim().slice(0, 28);
                if (label && !label.includes('▼') && !label.includes('▲') && !label.includes('✕')) {
                    addLog(`Targeted: ${label}`, 'info');
                }
            }
        }, { once: false });

        // Initial page log — only on first setup (not on SPA)
        if (STATE.logs.length === 0) {
            setTimeout(() => {
                const page = window.location.pathname === '/' ? '/home' : window.location.pathname;
                addLog(`Session established at ${page}`, 'success');
                showToast();
            }, 700);
        } else {
            // Navigation: just log the new page
            const page = window.location.pathname === '/' ? '/home' : window.location.pathname;
            addLog(`Navigated to ${page}`, 'info');
            showToast();
        }
    }

    setup();
    document.addEventListener('swup:content:replace', setup);
    document.addEventListener('astro:page-load', setup);
})();
</script>

<style>
    #console-logs {
        scrollbar-width: thin;
        scrollbar-color: var(--primary) transparent;
    }
    #console-logs::-webkit-scrollbar { width: 3px; }
    #console-logs::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }
    #ctrlk-toast {
        transition: opacity 0.4s ease, transform 0.4s ease;
    }
    #ctrlk-progress {
        transform: scaleX(1);
    }
</style>
