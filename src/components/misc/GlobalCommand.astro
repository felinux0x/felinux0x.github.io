<!-- ============================================================
     GLOBAL TERMINAL (Ctrl+K)
     Real shell experience with history, neofetch, all pages
     ============================================================ -->
<div id="global-terminal" class="fixed inset-0 z-[200] flex items-end sm:items-center justify-center bg-black/70 backdrop-blur-sm opacity-0 pointer-events-none transition-all duration-300">
    <div
        class="w-full sm:w-[90%] sm:max-w-2xl bg-[#0a0a0a] sm:border border-t border-[var(--primary)]/30 sm:rounded-xl shadow-[0_0_80px_-20px_var(--primary)] overflow-hidden transition-all duration-300 flex flex-col"
        id="terminal-modal"
        style="max-height: 80vh; min-height: 420px;"
    >
        <!-- Title bar -->
        <div class="flex items-center px-4 py-2.5 bg-[#111] border-b border-white/5 shrink-0">
            <div class="flex gap-1.5 mr-3">
                <div class="w-3 h-3 rounded-full bg-red-500/70 hover:bg-red-500 transition-colors cursor-pointer" id="term-close-btn"></div>
                <div class="w-3 h-3 rounded-full bg-yellow-500/70"></div>
                <div class="w-3 h-3 rounded-full bg-green-500/70"></div>
            </div>
            <span class="flex-1 text-center text-[10px] font-mono text-white/30 uppercase tracking-widest select-none">felps@offsec ‚Äî bash ‚Äî 120√ó30</span>
            <span class="text-[9px] font-mono text-white/20">Ctrl+K to toggle ¬∑ ESC to close</span>
        </div>

        <!-- Terminal output area -->
        <div id="terminal-output" class="flex-1 overflow-y-auto p-4 font-mono text-[11px] sm:text-xs space-y-0.5 min-h-0" style="scrollbar-width: thin; scrollbar-color: var(--primary) transparent;">
            <!-- Content generated by JS -->
        </div>

        <!-- Input line -->
        <div class="flex items-center px-4 py-3 border-t border-white/5 bg-[#0d0d0d] shrink-0">
            <span class="text-[var(--primary)] font-mono text-xs mr-2 whitespace-nowrap select-none">
                <span class="text-blue-400">felps</span>@<span class="text-purple-400">offsec</span>:<span class="text-yellow-400">~</span>#
            </span>
            <input
                type="text"
                id="terminal-input"
                class="flex-1 bg-transparent border-none outline-none text-white/90 font-mono text-xs placeholder:text-white/15 caret-[var(--primary)]"
                autocomplete="off"
                autocorrect="off"
                autocapitalize="off"
                spellcheck="false"
                placeholder="help"
            />
            <span class="w-[7px] h-[14px] bg-[var(--primary)] animate-[blink_1s_infinite] ml-1 opacity-80 shrink-0" id="cursor-blink"></span>
        </div>
    </div>
</div>

<script>
(function() {
    const NAV_COMMANDS = {
        'cd /'       : { action: 'nav', url: '/',           desc: 'Ir para home' },
        'cd /home'   : { action: 'nav', url: '/',           desc: 'Ir para home' },
        'cd /projetos': { action: 'nav', url: '/projetos/', desc: 'Ver projetos' },
        'cd /cheatsheet': { action: 'nav', url: '/cheatsheet/', desc: 'Abrir manual ofensivo' },
        'cd /blog'   : { action: 'nav', url: '/archive/',   desc: 'Ver todos os posts' },
        'cd /about'  : { action: 'nav', url: '/about/',     desc: 'Sobre mim' },
        'cd /github' : { action: 'ext', url: 'https://github.com/felinux0x', desc: 'GitHub externo' },
        'neofetch'   : { action: 'cmd', desc: 'Exibir info do sistema' },
        'help'       : { action: 'cmd', desc: 'Listar comandos dispon√≠veis' },
        'clear'      : { action: 'cmd', desc: 'Limpar o terminal' },
        'theme emerald': { action: 'theme', theme: 'emerald', desc: 'Tema Emerald (verde)' },
        'theme amber': { action: 'theme', theme: 'amber',   desc: 'Tema Amber (laranja)' },
        'theme cobalt': { action: 'theme', theme: 'cobalt',  desc: 'Tema Cobalt (azul)' },
        'theme crimson': { action: 'theme', theme: 'crimson', desc: 'Tema Crimson (vermelho)' },
        'whoami'     : { action: 'cmd', desc: 'Exibir usu√°rio atual' },
        'pwd'        : { action: 'cmd', desc: 'Exibir diret√≥rio atual' },
        'ls'         : { action: 'cmd', desc: 'Listar p√°ginas dispon√≠veis' },
        'uptime'     : { action: 'cmd', desc: 'Tempo ativo da sess√£o' },
        'uname -a'   : { action: 'cmd', desc: 'Info do sistema' },
        'exit'       : { action: 'cmd', desc: 'Fechar terminal' },
    };

    const NEOFETCH_ART = [
        '  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó',
        '  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù',
        '  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó',
        '  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë',
        '  ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë',
        '  ‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù',
        '                                           ',
    ];

    const getNeofetchInfo = () => {
        const theme = localStorage.getItem('tactical-theme') || 'emerald';
        const now = new Date().toLocaleString('pt-BR');
        const themeColor = { emerald: '#00ff7f', amber: '#ffaa00', cobalt: '#00a0ff', crimson: '#ff3232' };
        const c = themeColor[theme] || '#00ff7f';
        return [
            { key: null,       val: `<span style="color:#4fc3f7">felps</span><span class="text-white/40">@</span><span style="color:#ce93d8">offsec</span>` },
            { key: null,       val: `<span class="text-white/20">${'‚îÄ'.repeat(20)}</span>` },
            { key: 'OS',       val: 'Arch Linux GNU/Linux x86_64' },
            { key: 'Kernel',   val: '6.7.0-rt ‚Äî hardened' },
            { key: 'Shell',    val: 'zsh 5.9 + oh-my-zsh' },
            { key: 'WM',       val: 'Hyprland (Wayland)' },
            { key: 'Theme',    val: `<span style="color:${c}">${theme.toUpperCase()}</span> Tactical UI` },
            { key: 'Terminal', val: 'felps@offsec shell v2' },
            { key: 'CPU',      val: 'AMD Ryzen 7 4.8GHz' },
            { key: 'Memory',   val: '32GB DDR5 @ 6000MHz' },
            { key: 'Langs',    val: 'Python ¬∑ Go ¬∑ C# ¬∑ Bash ¬∑ ASM' },
            { key: 'Focus',    val: 'Red Team ¬∑ CTF ¬∑ Malware Analy.' },
            { key: null,       val: `<span class="text-white/20">${now}</span>` },
        ];
    };

    let history = [];
    let historyIndex = -1;
    let sessionStart = Date.now();
    let outputEl, inputEl, containerEl;

    function print(html, cls = '') {
        if (!outputEl) return;
        const line = document.createElement('div');
        line.className = 'leading-relaxed ' + cls;
        line.innerHTML = html;
        outputEl.appendChild(line);
        outputEl.scrollTop = outputEl.scrollHeight;
    }

    function printEmpty() { print(''); }

    function printPrompt(cmd) {
        print(`<span class="text-[var(--primary)]/60">‚ùØ</span> <span class="text-white/85">${escHtml(cmd)}</span>`);
    }

    function escHtml(str) {
        return String(str).replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function printHelp() {
        const groups = [
            { label: 'Navega√ß√£o',   cmds: [['cd /home | home', 'P√°gina inicial'], ['cd /projetos | projetos', 'Projetos'], ['cd /cheatsheet | cs', 'CheatSheet'], ['cd /blog | blog', 'Blog/Arquivo'], ['cd /about | sobre', 'Sobre mim'], ['cd /github', 'GitHub (externa)']] },
            { label: 'Sistema',     cmds: [['neofetch', 'Info do sistema'], ['ls', 'Listar p√°ginas'], ['whoami', 'Usu√°rio atual'], ['pwd', 'Diret√≥rio atual'], ['uptime', 'Tempo de sess√£o'], ['uname -a', 'Info kernel']] },
            { label: 'Temas',       cmds: [['theme emerald', '[E] Emerald ‚Äî verde t√°tico'], ['theme amber', '[A] Amber ‚Äî laranja'], ['theme cobalt', '[C] Cobalt ‚Äî azul'], ['theme crimson', '[R] Crimson ‚Äî vermelho']] },
            { label: 'Terminal',    cmds: [['clear', 'Limpar tela'], ['exit', 'Fechar terminal'], ['help', 'Esta ajuda']] },
        ];

        printEmpty();
        groups.forEach(({ label, cmds }) => {
            print(`<span class="text-[var(--primary)] font-bold uppercase tracking-widest text-[9px]">${label}</span>`);
            cmds.forEach(([cmd, desc]) => {
                print(`  <span class="text-white/85">${cmd}</span><span class="text-white/50 ml-3">‚Äî ${desc}</span>`);
            });
            printEmpty();
        });
        print('<span class="text-white/50 text-[10px]">‚Üë‚Üì hist√≥rico ¬∑ Tab autocomplete ¬∑ ESC fechar</span>');
    }

    function printNeofetch() {
        const info = getNeofetchInfo();
        const themeColor = { emerald: '#00ff7f', amber: '#ffaa00', cobalt: '#00a0ff', crimson: '#ff3232' };
        const theme = localStorage.getItem('tactical-theme') || 'emerald';
        const color = themeColor[theme] || '#00ff7f';
        const rows = Math.max(NEOFETCH_ART.length, info.length);

        printEmpty();

        // Use a wrapper div with flex for side-by-side art + info
        const wrapper = document.createElement('div');
        wrapper.style.display = 'flex';
        wrapper.style.gap = '1.5rem';
        wrapper.style.alignItems = 'flex-start';

        // Art column
        const artCol = document.createElement('div');
        artCol.style.flexShrink = '0';
        artCol.style.fontFamily = 'monospace';
        artCol.style.fontSize = '10px';
        artCol.style.lineHeight = '1.5';
        artCol.style.whiteSpace = 'pre';
        NEOFETCH_ART.forEach(line => {
            const el = document.createElement('div');
            el.style.color = color;
            el.style.fontWeight = 'bold';
            el.textContent = line;
            artCol.appendChild(el);
        });

        // Info column
        const infoCol = document.createElement('div');
        infoCol.style.fontFamily = 'monospace';
        infoCol.style.fontSize = '11px';
        infoCol.style.lineHeight = '1.6';
        info.forEach(({ key, val }) => {
            const el = document.createElement('div');
            if (key) {
                el.innerHTML = `<span style="color:${color};font-weight:bold">${key}</span><span style="color:rgba(255,255,255,0.45)"> ‚îÇ </span><span style="color:rgba(255,255,255,0.85)">${val}</span>`;
            } else {
                el.innerHTML = val;
            }
            infoCol.appendChild(el);
        });

        // Color palette
        const paletteEl = document.createElement('div');
        paletteEl.style.marginTop = '0.5rem';
        const colors = ['#1a1a2e','#8b0000','#006400','#8b6914','#00008b','#4b0082','#008080','#cccccc'];
        paletteEl.innerHTML = colors.map(c => `<span style="background:${c};color:${c};padding:0 6px">‚ñì</span>`).join('');
        infoCol.appendChild(paletteEl);

        wrapper.appendChild(artCol);
        wrapper.appendChild(infoCol);
        outputEl.appendChild(wrapper);
        outputEl.scrollTop = outputEl.scrollHeight;
        printEmpty();
    }

    function printLs() {
        const pages = [
            { name: 'home',       path: '/',            icon: 'üêß' },
            { name: 'blog',       path: '/archive/',    icon: 'üì°' },
            { name: 'projetos',   path: '/projetos/',   icon: 'üß∞' },
            { name: 'cheatsheet', path: '/cheatsheet/', icon: 'üîê' },
            { name: 'about',      path: '/about/',      icon: 'üÜî' },
            { name: 'github',     path: 'https://github.com/felinux0x', icon: '‚õìÔ∏è' },
        ];
        printEmpty();
        pages.forEach(p => print(`  ${p.icon} <span class="text-[var(--primary)]">${p.name}</span>  <span class="text-white/55">${p.path}</span>`));
        printEmpty();
    }

    function printUptime() {
        const elapsed = Date.now() - sessionStart;
        const totalSec = Math.floor(elapsed / 1000);
        const h = Math.floor(totalSec / 3600);
        const m = Math.floor((totalSec % 3600) / 60);
        const s = totalSec % 60;
        print(`up <span class="text-[var(--primary)]">${h}h ${m}m ${s}s</span>  ‚Äî  load average: 0.42, 0.37, 0.29`);
    }

    function navigate(url, label) {
        print(`<span class="text-green-400">‚úî Navigating ‚Üí ${escHtml(label || url)}</span>`);
        window.dispatchEvent(new CustomEvent('tactical-log', { detail: { message: `cd ${url}`, type: 'success' } }));
        setTimeout(() => { window.location.href = url; closeTerminal(); }, 350);
    }

    function handleCommand(raw) {
        const cmd = raw.trim();
        if (!cmd) return;

        history.unshift(cmd);
        if (history.length > 50) history.pop();
        historyIndex = -1;
        printPrompt(cmd);

        const lower = cmd.toLowerCase().trim();

        // Easter Eggs / CTF
        if (lower === 'sudo' || lower.startsWith('sudo ')) { print('<span class="text-red-500 font-bold">[!] User is not in the sudoers file. This incident will be reported.</span>'); return; }
        if (lower === 'whoami') { print('<span class="text-[var(--primary)] font-bold">root</span><br/><span class="text-white/40 text-[10px]">...just kidding, you are guest.</span>'); return; }
        if (lower === 'matrix') {
            print('<span class="text-green-500 font-bold">Wake up, Neo...</span>');
            document.documentElement.style.setProperty('--primary', '#00ff00');
            document.body.style.filter = 'contrast(1.5) drop-shadow(0 0 5px #00ff00)';
            setTimeout(() => {
                document.documentElement.style.removeProperty('--primary');
                document.body.style.filter = '';
                print('<span class="text-white/50">Matrix subroutine terminated.</span>');
            }, 10000);
            return;
        }
        if (lower.startsWith('submit ')) {
            const flag = lower.split(' ')[1];
            if (flag === 'felps{h1dd3n_1n_pl41n_51gh7}') {
                print('<span class="text-green-400 font-black text-lg">üö© FLAG ACCEPTED!</span><br/><span class="text-white/80">You found the backdoor. +100 HTB points.</span>');
                document.documentElement.setAttribute('data-theme', 'emerald');
                localStorage.setItem('tactical-theme', 'emerald');
                setTimeout(() => alert('You found the secret flag!'), 500);
            } else {
                print('<span class="text-red-500 font-bold">[x] Incorrect flag.</span>');
            }
            return;
        }

        // Built-ins
        if (lower === 'help' || lower === '?') { printHelp(); return; }
        if (lower === 'clear' || lower === 'cls') { if (outputEl) outputEl.innerHTML = ''; return; }
        if (lower === 'exit' || lower === 'quit' || lower === 'q') { closeTerminal(); return; }
        if (lower === 'neofetch') { printNeofetch(); return; }
        if (lower === 'pwd') { print(`<span class="text-white/80">/home/felps${window.location.pathname}</span>`); return; }
        if (lower === 'ls' || lower === 'dir') { printLs(); return; }
        if (lower === 'uptime') { printUptime(); return; }
        if (lower === 'uname -a' || lower === 'uname') { print('<span class="text-white/80">Linux offsec 6.7.0-rt-hardened #1 SMP PREEMPT_RT x86_64 GNU/Linux</span>'); return; }
        if (lower === 'date') { print(`<span class="text-white/80">${new Date().toLocaleString('pt-BR')}</span>`); return; }
        if (lower === 'id') { print('<span class="text-white/80">uid=1000(<span class="text-[var(--primary)]">felps</span>) gid=1000(felps) groups=1000(felps),998(wheel),970(docker)</span>'); return; }

        // Theme
        if (lower.startsWith('theme ')) {
            const t = lower.split(' ')[1];
            const valid = ['emerald', 'amber', 'cobalt', 'crimson'];
            if (valid.includes(t)) {
                document.documentElement.setAttribute('data-theme', t);
                localStorage.setItem('tactical-theme', t);
                print(`<span class="text-[var(--primary)]">‚úî Profile switched ‚Üí ${t.toUpperCase()}</span>`);
                window.dispatchEvent(new CustomEvent('tactical-log', { detail: { message: `Theme ‚Üí ${t.toUpperCase()}`, type: 'success' } }));
            } else {
                print(`<span class="text-red-400">Error: tema desconhecido '${escHtml(t)}'</span><span class="text-white/60"> ‚Äî v√°lidos: emerald, amber, cobalt, crimson</span>`);
            }
            return;
        }

        // Navigation ‚Äî accept with or without `cd `
        const navPart = lower.startsWith('cd ') ? lower.slice(3).trim() : lower;
        if (navPart === '/' || navPart === 'home' || navPart === '/home' || navPart === 'inicio') { navigate('/', '/home'); return; }
        if (navPart === '/projetos' || navPart === 'projetos' || navPart === 'projects') { navigate('/projetos/', 'Projetos'); return; }
        if (navPart === '/cheatsheet' || navPart === 'cheatsheet' || navPart === 'cs') { navigate('/cheatsheet/', 'CheatSheet'); return; }
        if (navPart === '/blog' || navPart === 'blog' || navPart === '/archive' || navPart === 'archive') { navigate('/archive/', 'Blog'); return; }
        if (navPart === '/about' || navPart === 'about' || navPart === 'sobre') { navigate('/about/', 'About'); return; }
        if (navPart === '/github' || navPart === 'github') {
            print('<span class="text-blue-400">‚Üí Opening GitHub in new tab...</span>');
            setTimeout(() => window.open('https://github.com/felinux0x', '_blank'), 200);
            return;
        }

        // Unknown
        print(`<span class="text-red-400">${escHtml(cmd)}: comando n√£o encontrado</span><span class="text-white/60"> ‚Äî tente: <span class="text-[var(--primary)]">help</span></span>`);
    }

    function openTerminal() {
        if (!containerEl) return;
        containerEl.classList.remove('opacity-0', 'pointer-events-none');
        setTimeout(() => inputEl?.focus(), 40);
        window.dispatchEvent(new CustomEvent('tactical-log', { detail: { message: 'Terminal session opened', type: 'warning' } }));
        if (outputEl && outputEl.children.length === 0) {
            print('<span class="text-[var(--primary)] font-bold">felps@offsec</span> <span class="text-white/60">‚Äî bash 5.2.21(1)-release</span>');
            print('<span class="text-white/60">Type <span class="text-[var(--primary)]">help</span> for commands  ¬∑  <span class="text-[var(--primary)]">neofetch</span> for sysinfo  ¬∑  <span class="text-[var(--primary)]">ls</span> for pages</span>');
            printEmpty();
        }
    }

    function closeTerminal() {
        if (!containerEl) return;
        containerEl.classList.add('opacity-0', 'pointer-events-none');
    }

    function autocomplete(val) {
        if (!val) return;
        const all = ['help', 'neofetch', 'ls', 'clear', 'exit', 'whoami', 'pwd', 'uptime', 'uname -a', 'date', 'id',
                     'cd /home', 'cd /projetos', 'cd /cheatsheet', 'cd /blog', 'cd /about', 'cd /github',
                     'theme emerald', 'theme amber', 'theme cobalt', 'theme crimson'];
        const matches = all.filter(c => c.startsWith(val.toLowerCase()) && c !== val.toLowerCase());
        if (matches.length === 1) {
            inputEl.value = matches[0];
        } else if (matches.length > 1) {
            print(`<span class="text-white/60">${matches.join('   ')}</span>`);
        }
    }

    function setup() {
        containerEl = document.getElementById('global-terminal');
        outputEl    = document.getElementById('terminal-output');
        inputEl     = document.getElementById('terminal-input');

        if (!containerEl || !inputEl) return;

        document.getElementById('term-close-btn')?.addEventListener('click', closeTerminal);

        window.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                const isOpen = !containerEl.classList.contains('opacity-0');
                isOpen ? closeTerminal() : openTerminal();
            }
            if (e.key === 'Escape') closeTerminal();
        });

        containerEl.addEventListener('click', (e) => {
            if (e.target === containerEl) closeTerminal();
        });

        inputEl.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') { handleCommand(inputEl.value); inputEl.value = ''; }
            if (e.key === 'Tab') { e.preventDefault(); autocomplete(inputEl.value); }
            if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (historyIndex < history.length - 1) { historyIndex++; inputEl.value = history[historyIndex]; }
            }
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (historyIndex > 0) { historyIndex--; inputEl.value = history[historyIndex]; }
                else { historyIndex = -1; inputEl.value = ''; }
            }
        });

        // Theme init
        const savedTheme = localStorage.getItem('tactical-theme') || 'emerald';
        document.documentElement.setAttribute('data-theme', savedTheme);
    }

    setup();
    document.addEventListener('swup:content:replace', setup);
    document.addEventListener('astro:page-load', setup);
})();
</script>

<style>
    @keyframes blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0; }
    }

    #terminal-output::-webkit-scrollbar { width: 4px; }
    #terminal-output::-webkit-scrollbar-thumb {
        background: var(--primary);
        border-radius: 4px;
        opacity: 0.3;
    }

    #terminal-input::selection {
        background: var(--primary);
        color: black;
    }

    /* Hide default cursor when terminal shows a fake blink one */
    #terminal-input {
        caret-color: transparent;
    }
</style>
